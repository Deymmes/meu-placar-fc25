<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EA FC Pro - Cloud Elite</title>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        :root {
            --bg: #0f172a; --card-bg: rgba(30, 41, 59, 0.7);
            --accent: #3b82f6; --gold: #f59e0b;
            --success: #10b981; --text: #f8fafc;
            --danger: #ef4444;
        }

        body {
            font-family: 'Inter', system-ui, sans-serif; background-color: var(--bg);
            background-image: radial-gradient(circle at top right, #1e293b, #0f172a);
            color: var(--text); padding: 10px; margin: 0; min-height: 100vh;
        }

        .container { max-width: 800px; margin: auto; }
        
        /* Cabe√ßalho e Sala */
        .room-badge { background: var(--gold); color: black; padding: 2px 12px; border-radius: 20px; font-size: 0.65rem; font-weight: 900; text-transform: uppercase; cursor: pointer; display: inline-block; margin-bottom: 5px; }
        .header-section { text-align: center; margin-bottom: 20px; }
        h1 { text-transform: uppercase; font-weight: 900; font-size: 1.1rem; background: linear-gradient(to right, #fff, var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 0; }

        .section-title { display: flex; align-items: center; gap: 10px; margin: 25px 0 15px 0; text-transform: uppercase; font-size: 0.7rem; font-weight: 900; color: var(--gold); letter-spacing: 1.5px; }
        .section-title::after { content: ""; flex: 1; height: 1px; background: linear-gradient(to right, rgba(245, 158, 11, 0.5), transparent); }

        /* Filtros */
        .filter-section { background: var(--card-bg); border-radius: 12px; padding: 8px; margin: 10px 0; display: flex; gap: 6px; border: 1px solid rgba(255,255,255,0.1); overflow-x: auto; scrollbar-width: none; }
        .filter-chip { font-size: 0.6rem; background: rgba(15, 23, 42, 0.8); padding: 5px 10px; border-radius: 20px; border: 1px solid #475569; cursor: pointer; color: #94a3b8; font-weight: bold; white-space: nowrap; }
        .filter-chip.active { border-color: var(--gold); color: white; background: rgba(245, 158, 11, 0.4); }
        .filter-chip input { display: none; }

        /* Rankings */
        .rankings-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .rank-card { background: var(--card-bg); border-radius: 10px; padding: 10px; border: 1px solid rgba(255,255,255,0.1); }
        .rank-card h3 { margin: 0 0 10px 0; font-size: 0.55rem; color: var(--gold); text-align: center; text-transform: uppercase; }
        .rank-item { display: flex; justify-content: space-between; padding: 5px 0; font-size: 0.8rem; border-bottom: 1px solid rgba(255,255,255,0.05); }

        /* Grid de Partidas Sim√©trico */
        .match-row { display: grid; grid-template-columns: 1fr 45px 24px 45px 1fr 35px; align-items: center; padding: 15px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .player-side.left { text-align: right; align-items: flex-end; padding-right: 18px; }
        .player-side.right { text-align: left; align-items: flex-start; padding-left: 18px; }
        .p-name { font-size: 0.8rem; font-weight: 800; color: #fff; text-transform: uppercase; }
        .t-input { background: rgba(15, 23, 42, 0.9); border: 1px solid rgba(255,255,255,0.1); color: #fff; padding: 4px 0; border-radius: 4px; font-size: 0.65rem; width: 100%; text-align: center; outline: none; }
        .score-input { background: var(--accent); border: none; border-radius: 6px; color: white; height: 40px; font-size: 1.3rem; font-weight: 900; text-align: center; width: 45px; }
        .score-input:disabled { background: #334155; opacity: 0.6; }
        
        .btn-lock { background: none; border: none; font-size: 1.1rem; cursor: pointer; padding: 0; opacity: 0.7; }
        .btn-dice { background: none; border: none; cursor: pointer; font-size: 0.9rem; filter: grayscale(1); }

        /* Rivalidade e Barra */
        .rivalry-section { background: linear-gradient(180deg, rgba(30, 41, 59, 0.9) 0%, rgba(15, 23, 42, 1) 100%); border-radius: 16px; padding: 20px; border: 1px solid rgba(245, 158, 11, 0.3); }
        .rivalry-score-big { font-size: 2.2rem; font-weight: 900; color: var(--gold); text-align: center; }
        .dominance-bar-container { height: 6px; background: rgba(255,255,255,0.1); border-radius: 10px; margin: 15px 0; overflow: hidden; display: flex; }
        .dom-fill { height: 100%; transition: width 0.5s ease; }

        /* Bot√µes */
        .btn-finish { background: var(--success); color: white; width: 100%; padding: 16px; border-radius: 12px; border: none; font-weight: 900; text-transform: uppercase; cursor: pointer; margin-top: 20px; }
        .btn-small { background: transparent; color: #94a3b8; border: none; font-size: 0.7rem; cursor: pointer; margin-top: 10px; width: 100%; }
    </style>
</head>
<body>

<div class="container">
    <div class="header-section">
        <div id="status-sala" class="room-badge" onclick="trocarSala()">SALA: <span id="label-sala">...</span></div>
        <h1>Champions EA FC Pro Cloud</h1>
        <div style="margin-top: 15px;">
            <input type="text" id="player-names" onchange="salvarPlayersNoFirebase()" value="Jo√£o, Deymmes, Dario" style="background:transparent; border:none; border-bottom:2px solid var(--accent); color:white; text-align:center; font-size:1.1rem; font-weight:bold; width:80%; outline:none;">
        </div>

        <div id="filter-ui" class="filter-section">
            <label class="filter-chip active"><input type="checkbox" value="top3" checked onchange="updateChip(this)">‚≠ê TOP 3</label>
            <label class="filter-chip"><input type="checkbox" value="ing" onchange="updateChip(this)">ING</label>
            <label class="filter-chip"><input type="checkbox" value="esp" onchange="updateChip(this)">ESP</label>
            <label class="filter-chip"><input type="checkbox" value="ita" onchange="updateChip(this)">ITA</label>
            <label class="filter-chip"><input type="checkbox" value="sel" onchange="updateChip(this)">SEL</label>
        </div>
    </div>

    <div class="section-title">üèÜ Quadro de Honra</div>
    <div class="rankings-row">
        <div class="rank-card"><h3>T√≠tulos</h3><div id="hist-titulos"></div></div>
        <div class="rank-card"><h3>Pontos</h3><div id="hist-pontos"></div></div>
        <div class="rank-card"><h3>Gols</h3><div id="hist-gols"></div></div>
    </div>

    <div class="section-title">üìä Campeonato em Andamento</div>
    <div class="rank-card" style="padding: 10px;">
        <table width="100%" style="font-size: 0.85rem; border-collapse: collapse;">
            <thead><tr style="color: #94a3b8"><th>Pos</th><th align="left">Player</th><th>P</th><th>V</th><th>SG</th></tr></thead>
            <tbody id="corpo-tabela" align="center"></tbody>
        </table>
    </div>

    <div class="section-title">üïπÔ∏è Confrontos da Rodada</div>
    <div id="lista-confrontos"></div>

    <div class="section-title">‚öîÔ∏è An√°lise de Rivalidade</div>
    <div class="rivalry-section">
        <div style="display: flex; gap: 10px; justify-content: center; margin-bottom: 15px;">
            <select id="p1-select" class="t-input" onchange="renderRivalidade()" style="width: 40%; height: 35px;"></select>
            <span style="color: var(--gold); font-weight: bold; align-self: center;">VS</span>
            <select id="p2-select" class="t-input" onchange="renderRivalidade()" style="width: 40%; height: 35px;"></select>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 100px 1fr; align-items: center;">
            <div id="rival-name-1" align="right" style="font-weight: 900; font-size: 0.9rem;">-</div>
            <div class="rivalry-score-big"><span id="rival-v-1">0</span>:<span id="rival-v-2">0</span></div>
            <div id="rival-name-2" align="left" style="font-weight: 900; font-size: 0.9rem;">-</div>
        </div>
        <div class="dominance-bar-container">
            <div id="bar-1" class="dom-fill" style="background: var(--accent); width: 50%;"></div>
            <div id="bar-2" class="dom-fill" style="background: var(--gold); width: 50%;"></div>
        </div>
    </div>

    <button class="btn-finish" onclick="finalizarTurnoCloud()">Encerrar e Sincronizar</button>
    <button class="btn-small" onclick="adminResetSala()">‚öôÔ∏è ADMIN: RESETAR OU DESTRAVAR SALA</button>
</div>

<script>
// --- FIREBASE CONFIG ---
const MASTER_KEY = "1234"; // SUA SENHA
const firebaseConfig = {
  apiKey: "AIzaSyDZ1MD_w9Zt6Hyl0jZlvNv3gSP5j0UVY6E",
  authDomain: "ea-fc-pro.firebaseapp.com",
  databaseURL: "https://ea-fc-pro-default-rtdb.firebaseio.com",
  projectId: "ea-fc-pro",
  storageBucket: "ea-fc-pro.firebasestorage.app",
  messagingSenderId: "1017852236404",
  appId: "1:1017852236404:web:dd32d9e180b1a101d47721"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// --- SALAS ---
const urlParams = new URLSearchParams(window.location.search);
let salaAtual = urlParams.get('sala') || 'Resenha';
document.getElementById('label-sala').innerText = salaAtual;

function trocarSala() {
    const n = prompt("Nome da Sala:", salaAtual);
    if(n) window.location.search = "?sala=" + n.replace(/\s+/g, '');
}

// --- DADOS ---
let cloudData = { players: "Jo√£o, Deymmes, Dario", ranking: {}, jogos: {}, rivalidade: {} };

db.ref('salas/' + salaAtual).on('value', (snap) => {
    const d = snap.val();
    if(d) {
        cloudData = d;
        document.getElementById('player-names').value = d.players;
        atualizarTudo();
    }
});

function salvarPlayersNoFirebase() {
    db.ref(`salas/${salaAtual}`).update({ players: document.getElementById('player-names').value });
}

function updateChip(el) { el.parentElement.classList.toggle('active', el.checked); }

function atualizarTudo() {
    const pList = cloudData.players.split(',').map(n => n.trim());
    
    // 1. Rankings
    const hist = cloudData.ranking || {};
    const r = (f) => pList.sort((a,b) => (hist[b]?.[f]||0) - (hist[a]?.[f]||0)).map(p => `<div class="rank-item"><span>${p}</span><b>${hist[p]?.[f]||0}</b></div>`).join('');
    document.getElementById('hist-titulos').innerHTML = r('titulos');
    document.getElementById('hist-pontos').innerHTML = r('pontos');
    document.getElementById('hist-gols').innerHTML = r('gols');

    // 2. Selects Rivalidade
    const opts = pList.map(p => `<option value="${p}">${p}</option>`).join('');
    document.getElementById('p1-select').innerHTML = opts; document.getElementById('p2-select').innerHTML = opts;

    // 3. Grid de Jogos
    let html = '<div class="match-section">';
    const jData = cloudData.jogos || {};
    for(let i=0; i<pList.length; i++) {
        for(let j=i+1; j<pList.length; j++) {
            const id = `j_${i}_${j}`;
            const jg = jData[id] || { g1: "", g2: "", tentativas: 0, t1: "", t2: "" };
            const travado = jg.tentativas >= 2;
            
            html += `<div class="match-row">
                <div class="player-side left">
                    <span class="p-name">${pList[i]}</span>
                    <input class="t-input" id="${id}t1" placeholder="Time" value="${jg.t1 || ''}" onchange="salvarTime('${id}', 1, this.value)">
                </div>
                <input type="number" class="score-input" id="${id}s1" value="${jg.g1}" ${travado?'disabled':''}>
                <div style="text-align:center; opacity:0.3">x</div>
                <input type="number" class="score-input" id="${id}s2" value="${jg.g2}" ${travado?'disabled':''}>
                <div class="player-side right">
                    <span class="p-name">${pList[j]}</span>
                    <input class="t-input" id="${id}t2" placeholder="Time" value="${jg.t2 || ''}" onchange="salvarTime('${id}', 2, this.value)">
                </div>
                <button class="btn-lock" onclick="confirmarPlacar('${id}')">${travado?'üîí':'üîì'}</button>
            </div>`;
        }
    }
    document.getElementById('lista-confrontos').innerHTML = html + '</div>';
    calcularTabelaAndamento();
    renderRivalidade();
}

function salvarTime(id, pNum, val) {
    db.ref(`salas/${salaAtual}/jogos/${id}`).update({ ['t' + pNum]: val });
}

function confirmarPlacar(id) {
    const g1 = document.getElementById(id+'s1').value;
    const g2 = document.getElementById(id+'s2').value;
    if(g1 === "" || g2 === "") return alert("Digite o placar!");

    const jg = cloudData.jogos?.[id] || { tentativas: 0 };
    if(jg.tentativas >= 2) return alert("Limite de edi√ß√µes atingido!");

    if(confirm(`Confirmar? (Tentativa ${jg.tentativas + 1}/2)`)) {
        db.ref(`salas/${salaAtual}/jogos/${id}`).update({
            g1: parseInt(g1), g2: parseInt(g2), tentativas: jg.tentativas + 1
        });
    }
}

function calcularTabelaAndamento() {
    const pList = cloudData.players.split(',').map(n => n.trim());
    let t = {}; pList.forEach(p => t[p] = { p: 0, v: 0, sg: 0, gp: 0 });
    
    const jData = cloudData.jogos || {};
    document.querySelectorAll('.match-row').forEach(row => {
        const pNames = row.querySelectorAll('.p-name');
        const scores = row.querySelectorAll('.score-input');
        const g1 = scores[0].value !== "" ? parseInt(scores[0].value) : null;
        const g2 = scores[1].value !== "" ? parseInt(scores[1].value) : null;
        
        if(g1 !== null && g2 !== null) {
            const p1 = pNames[0].innerText; const p2 = pNames[1].innerText;
            t[p1].gp += g1; t[p2].gp += g2; t[p1].sg += (g1-g2); t[p2].sg += (g2-g1);
            if(g1 > g2) { t[p1].p += 3; t[p1].v += 1; }
            else if(g2 > g1) { t[p2].p += 3; t[p2].v += 1; }
            else { t[p1].p += 1; t[p2].p += 1; }
        }
    });

    const ord = Object.entries(t).sort((a,b) => b[1].p - a[1].p || b[1].sg - a[1].sg);
    document.getElementById('corpo-tabela').innerHTML = ord.map((p, i) => `<tr><td style="font-weight:900">${i+1}¬∫</td><td align="left">${p[0]}</td><td style="color:var(--gold); font-weight:900">${p[1].p}</td><td>${p[1].v}</td><td>${p[1].sg}</td></tr>`).join('');
    return t;
}

function renderRivalidade() {
    const p1 = document.getElementById('p1-select').value;
    const p2 = document.getElementById('p2-select').value;
    if(!p1 || !p2 || p1 === p2) return;
    const chave = [p1, p2].sort().join('_vs_');
    const dados = (cloudData.rivalidade || {})[chave] || { [p1]: 0, [p2]: 0 };
    
    document.getElementById('rival-name-1').innerText = p1;
    document.getElementById('rival-name-2').innerText = p2;
    document.getElementById('rival-v-1').innerText = dados[p1] || 0;
    document.getElementById('rival-v-2').innerText = dados[p2] || 0;
    
    const total = (dados[p1]||0) + (dados[p2]||0);
    const perc = total === 0 ? 50 : (dados[p1]/total)*100;
    document.getElementById('bar-1').style.width = perc + "%";
    document.getElementById('bar-2').style.width = (100 - perc) + "%";
}

function finalizarTurnoCloud() {
    const s = calcularTabelaAndamento();
    const win = document.querySelector('#corpo-tabela tr td:nth-child(2)').innerText;
    
    if(confirm(`Finalizar Turno? Campe√£o: ${win}`)) {
        const pass = prompt("Senha Master:");
        if(pass !== MASTER_KEY) return alert("Senha errada!");

        const hist = cloudData.ranking || {};
        const pList = cloudData.players.split(',').map(n => n.trim());
        
        pList.forEach(p => {
            if(!hist[p]) hist[p] = { titulos: 0, pontos: 0, gols: 0 };
            hist[p].pontos += s[p].p; hist[p].gols += s[p].gp;
        });
        hist[win].titulos++;

        // Atualizar Rivalidade
        const jData = cloudData.jogos || {};
        Object.entries(jData).forEach(([id, jg]) => {
            if(jg.g1 !== "" && jg.g2 !== "" && jg.g1 !== jg.g2) {
                const pNames = cloudData.players.split(',').map(n => n.trim());
                const parts = id.split('_');
                const p1 = pNames[parts[1]]; const p2 = pNames[parts[2]];
                const winner = jg.g1 > jg.g2 ? p1 : p2;
                const chave = [p1, p2].sort().join('_vs_');
                if(!cloudData.rivalidade) cloudData.rivalidade = {};
                if(!cloudData.rivalidade[chave]) cloudData.rivalidade[chave] = { [p1]:0, [p2]:0 };
                cloudData.rivalidade[chave][winner]++;
            }
        });

        confetti({ particleCount: 200 });
        db.ref(`salas/${salaAtual}`).update({ ranking: hist, jogos: null, rivalidade: cloudData.rivalidade || {} });
    }
}

function adminResetSala() {
    const pass = prompt("Senha Master:");
    if(pass === MASTER_KEY) {
        const acao = prompt("1: Destravar Jogos | 2: Reset Total da Sala");
        if(acao === "1") {
            const j = cloudData.jogos || {};
            Object.keys(j).forEach(k => j[k].tentativas = 0);
            db.ref(`salas/${salaAtual}/jogos`).set(j);
        } else if(acao === "2") {
            if(confirm("Apagar TUDO desta sala?")) db.ref(`salas/${salaAtual}`).remove();
        }
    }
}
</script>
</body>
</html>
