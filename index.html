<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EA FC Pro - Elite Edition Cloud</title>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --bg: #0f172a; --card-bg: rgba(30, 41, 59, 0.7);
            --accent: #3b82f6; --gold: #f59e0b;
            --success: #10b981; --text: #f8fafc;
            --danger: #ef4444;
        }

        body {
            font-family: 'Inter', system-ui, sans-serif; background-color: var(--bg);
            background-image: radial-gradient(circle at top right, #1e293b, #0f172a);
            color: var(--text); padding: 10px; margin: 0; min-height: 100vh;
        }

        .container { max-width: 800px; margin: auto; }
        .header-section { text-align: center; margin-bottom: 25px; }
        h1 { text-transform: uppercase; font-weight: 900; font-size: 1.1rem; background: linear-gradient(to right, #fff, var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 0; }

        /* BADGE DE SALA COM √çCONE DE + */
        .room-badge { 
            background: var(--gold); 
            color: black; 
            padding: 4px 12px; 
            border-radius: 20px; 
            font-size: 0.65rem; 
            font-weight: 900; 
            text-transform: uppercase; 
            cursor: pointer; 
            display: inline-flex; 
            align-items: center; 
            gap: 8px;
            margin-bottom: 8px; 
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
            transition: all 0.2s ease;
        }
        .room-badge:active { transform: scale(0.95); opacity: 0.9; }
        .plus-icon { 
            background: rgba(0,0,0,0.15); 
            width: 16px; 
            height: 16px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            border-radius: 50%; 
            font-size: 1rem;
            line-height: 1;
        }

        .section-title {
            display: flex; align-items: center; gap: 10px; margin: 30px 0 15px 0;
            text-transform: uppercase; font-size: 0.7rem; font-weight: 900; color: var(--gold); letter-spacing: 1.5px;
        }
        .section-title::after { content: ""; flex: 1; height: 1px; background: linear-gradient(to right, rgba(245, 158, 11, 0.5), transparent); }

        .mode-badge { font-size: 0.6rem; background: var(--accent); color: white; padding: 2px 8px; border-radius: 10px; text-transform: uppercase; font-weight: bold; margin-bottom: 5px; display: inline-block; }

        .filter-section { 
            background: var(--card-bg); border-radius: 12px; padding: 8px; margin: 10px 0; 
            display: flex; gap: 6px; border: 1px solid rgba(255,255,255,0.1); 
            overflow-x: auto; scrollbar-width: none;
        }
        .filter-section::-webkit-scrollbar { display: none; }
        .filter-chip { 
            font-size: 0.6rem; background: rgba(15, 23, 42, 0.8); padding: 5px 10px; 
            border-radius: 20px; border: 1px solid #475569; cursor: pointer; color: #94a3b8; 
            font-weight: bold; white-space: nowrap;
        }
        .filter-chip.active { border-color: var(--gold); color: white; background: rgba(245, 158, 11, 0.4); }
        .filter-chip input { display: none; }
        .btn-all-toggle { font-size: 0.6rem; background: var(--gold); color: black; padding: 5px 10px; border-radius: 20px; border: none; font-weight: 900; cursor: pointer; }

        .rankings-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 15px; }
        .rank-card { background: var(--card-bg); border-radius: 10px; padding: 8px; border: 1px solid rgba(255,255,255,0.1); }
        .rank-item { display: flex; justify-content: space-between; padding: 4px 0; font-size: 0.75rem; border-bottom: 1px solid rgba(255,255,255,0.05); }

        .table-container { background: var(--card-bg); border-radius: 12px; padding: 10px; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.1); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        td { padding: 8px 4px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.05); }

        .match-row { 
            display: grid; 
            grid-template-columns: 1fr 45px 25px 45px 1fr 35px; 
            align-items: center; 
            padding: 15px 0; 
            border-bottom: 1px solid rgba(255,255,255,0.05); 
            width: 100%;
        }
        .match-row:last-child { border-bottom: none; }
        
        .player-side { display: flex; flex-direction: column; gap: 4px; min-width: 0; }
        .player-side.left { text-align: right; align-items: flex-end; padding-right: 18px; }
        .player-side.right { text-align: left; align-items: flex-start; padding-left: 18px; }

        .p-name { font-size: 0.8rem; font-weight: 800; color: #fff; text-transform: uppercase; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; }
        .t-input { 
            background: rgba(15, 23, 42, 0.9); border: 1px solid rgba(255,255,255,0.1); 
            color: #fff; padding: 4px 0; border-radius: 4px; 
            font-size: 0.65rem; width: 100%; outline: none; text-align: center;
        }

        .score-input { 
            background: var(--accent); border: none; border-radius: 6px; color: white; 
            height: 42px; font-size: 1.4rem; font-weight: 900; text-align: center; width: 45px; 
        }
        .score-input:disabled { background: #334155; opacity: 0.6; }
        .btn-lock { background: none; border: none; font-size: 1.1rem; cursor: pointer; opacity: 0.7; }

        .rivalry-section { 
            background: linear-gradient(180deg, rgba(30, 41, 59, 0.9) 0%, rgba(15, 23, 42, 1) 100%);
            border-radius: 16px; padding: 20px; margin: 10px 0 25px 0; border: 1px solid rgba(245, 158, 11, 0.3);
        }
        .dominance-bar-container { height: 6px; background: rgba(255,255,255,0.1); border-radius: 10px; margin: 20px 0; overflow: hidden; display: flex; }
        .dom-fill { height: 100%; transition: width 0.5s ease; }
        .last-winner-badge { display: inline-block; padding: 4px 12px; border-radius: 20px; border: 1px solid var(--gold); color: var(--gold); font-size: 0.7rem; font-weight: 900; text-transform: uppercase; }

        .btn-finish { background: var(--success); color: white; width: 100%; padding: 16px; border-radius: 12px; border: none; font-weight: 900; text-transform: uppercase; cursor: pointer; margin-top: 10px; }
        .btn-clear-session { background: rgba(239, 68, 68, 0.1); color: var(--danger); border: 1px solid var(--danger); width: 100%; padding: 10px; border-radius: 10px; font-size: 0.75rem; font-weight: bold; cursor: pointer; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="container" id="capture-area">
    <div class="header-section">
        <div class="room-badge" onclick="trocarSala()" title="Clique para trocar ou criar sala">
            <span>Sala: <span id="label-sala">...</span></span>
            <span class="plus-icon">+</span>
        </div>
        
        <h1>Champions EA FC Pro</h1>
        <div id="display-modo" class="mode-badge">Conectando...</div>
        <div style="margin-bottom: 10px;">
            <input type="text" id="player-names" onchange="salvarPlayersNuvem()" value="Jo√£o, Deymmes, Dario" style="background:transparent; border:none; border-bottom:2px solid var(--accent); color:white; text-align:center; font-size:1.1rem; font-weight:bold; width:80%; outline:none; padding: 5px;">
        </div>
        
        <div id="filter-ui" class="filter-section">
            <button class="btn-all-toggle" onclick="toggleTodos()">TDS</button>
            <label class="filter-chip active"><input type="checkbox" value="top3" checked onchange="updateChip(this)">‚≠ê TOP 3</label>
            <label class="filter-chip"><input type="checkbox" value="ing" onchange="updateChip(this)">ING</label>
            <label class="filter-chip"><input type="checkbox" value="esp" onchange="updateChip(this)">ESP</label>
            <label class="filter-chip"><input type="checkbox" value="ita" onchange="updateChip(this)">ITA</label>
            <label class="filter-chip"><input type="checkbox" value="ale" onchange="updateChip(this)">ALE</label>
            <label class="filter-chip"><input type="checkbox" value="fra" onchange="updateChip(this)">FRA</label>
            <label class="filter-chip"><input type="checkbox" value="sel" onchange="updateChip(this)">SEL</label>
            <label class="filter-chip"><input type="checkbox" value="out" onchange="updateChip(this)">OUT</label>
        </div>
    </div>

    <div class="section-title">üèÜ Quadro de Honra</div>
    <div class="rankings-row">
        <div class="rank-card"><h3 style="margin:0 0 8px 0; font-size:0.5rem; color:var(--gold); text-align:center; text-transform:uppercase;">üèÜ T√≠tulos</h3><div id="hist-titulos"></div></div>
        <div class="rank-card"><h3 style="margin:0 0 8px 0; font-size:0.5rem; color:var(--gold); text-align:center; text-transform:uppercase;">üìà Pontos</h3><div id="hist-pontos"></div></div>
        <div class="rank-card"><h3 style="margin:0 0 8px 0; font-size:0.5rem; color:var(--gold); text-align:center; text-transform:uppercase;">‚öΩ Gols</h3><div id="hist-gols"></div></div>
    </div>

    <div class="section-title">üìä Campeonato em Andamento</div>
    <div class="table-container">
        <table>
            <thead><tr><th style="font-size:0.65rem; color:#94a3b8">Pos</th><th style="text-align:left; font-size:0.65rem; color:#94a3b8">Player</th><th style="font-size:0.65rem; color:#94a3b8">P</th><th style="font-size:0.65rem; color:#94a3b8">V</th><th style="font-size:0.65rem; color:#94a3b8">E</th><th style="font-size:0.65rem; color:#94a3b8">D</th><th style="font-size:0.65rem; color:#94a3b8">SG</th></tr></thead>
            <tbody id="corpo-tabela"></tbody>
        </table>
    </div>

    <div class="section-title">üïπÔ∏è Confrontos da Rodada</div>
    <div id="lista-confrontos"></div>

    <div class="section-title">‚öîÔ∏è An√°lise de Rivalidade</div>
    <div class="rivalry-section">
        <div style="display: flex; gap: 10px; justify-content: center; margin-bottom: 20px;">
            <select id="p1-select" class="t-input" onchange="renderRivalidade()" style="width: 45%; height: 35px;"></select>
            <span style="color: var(--gold); font-weight: bold; align-self: center;">VS</span>
            <select id="p2-select" class="t-input" onchange="renderRivalidade()" style="width: 45%; height: 35px;"></select>
        </div>
        <div class="rivalry-grid" style="display: grid; grid-template-columns: 1fr 100px 1fr; align-items: center; gap: 10px;">
            <div id="rival-p1-name" style="text-align: right; font-weight:900; font-size:0.95rem; color:white;">-</div>
            <div style="font-size: 2.2rem; font-weight: 900; color: var(--gold); text-align: center;"><span id="rival-v-1">0</span>:<span id="rival-v-2">0</span></div>
            <div id="rival-p2-name" style="text-align: left; font-weight:900; font-size:0.95rem; color:white;">-</div>
        </div>
        <div class="dominance-bar-container">
            <div id="bar-1" class="dom-fill" style="background:var(--accent); width: 50%;"></div>
            <div id="bar-2" class="dom-fill" style="background:var(--gold); width: 50%;"></div>
        </div>
        <div style="text-align: center;"><div class="last-winner-badge">√öltimo: <span id="val-ultimo">-</span></div></div>
    </div>

    <button class="btn-clear-session" onclick="limparPlacaresNuvem()">üßπ Limpar placares desta rodada</button>
    <button class="btn-finish" onclick="finalizarTurno()">Encerrar e Sincronizar Tudo</button>
</div>

<script>
const MASTER_KEY = "1234"; 
const firebaseConfig = {
    apiKey: "AIzaSyDZ1MD_w9Zt6Hyl0jZlvNv3gSP5j0UVY6E",
    authDomain: "ea-fc-pro.firebaseapp.com",
    databaseURL: "https://ea-fc-pro-default-rtdb.firebaseio.com",
    projectId: "ea-fc-pro",
    storageBucket: "ea-fc-pro.firebasestorage.app",
    messagingSenderId: "1017852236404",
    appId: "1:1017852236404:web:dd32d9e180b1a101d47721"
};

const timesPool = {
    ing: ["Man. City", "Liverpool", "Chelsea", "Arsenal", "Tottenham"],
    esp: ["Real Madrid", "Barcelona", "Atl√©tico Madrid"],
    ita: ["Inter Mil√£o", "Juventus", "AC Milan"],
    ale: ["Bayer Leverkusen", "Bayern M√ºnchen", "Borussia Dortmund"],
    fra: ["PSG", "M√¥naco", "Marseille"],
    sel: ["Brasil üáßüá∑", "Espanha üá™üá∏", "Fran√ßa üá´üá∑", "Argentina üá¶üá∑"],
    top3: ["Real Madrid", "Man. City", "Bayern M√ºnchen", "PSG", "Inter Mil√£o"],
    out: ["Inter Miami", "Benfica", "Porto", "Ajax"]
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const urlParams = new URLSearchParams(window.location.search);
let salaAtual = urlParams.get('sala') || localStorage.getItem('FC_LAST_ROOM') || 'Resenha';
document.getElementById('label-sala').innerText = salaAtual;

let cloudData = { players: "Jo√£o, Deymmes, Dario", ranking_torneio: {}, ranking_duelo: {}, jogos: {}, rivalidade: {} };

db.ref('salas/' + salaAtual).on('value', (snap) => {
    const d = snap.val();
    if(d) cloudData = d;
    atualizarInterface();
});

function trocarSala() {
    const n = prompt("Crie ou entre em uma sala (Ex: AmigosFC):", salaAtual);
    if(n) {
        const salaLimpa = n.replace(/\s+/g, '');
        localStorage.setItem('FC_LAST_ROOM', salaLimpa);
        window.location.search = "?sala=" + salaLimpa;
    }
}

function updateChip(el) { el.parentElement.classList.toggle('active', el.checked); }
function toggleTodos() {
    const inputs = document.querySelectorAll('#filter-ui input');
    const algumOff = Array.from(inputs).some(i => !i.checked);
    inputs.forEach(i => { i.checked = algumOff; updateChip(i); });
}

function atualizarInterface() {
    const pList = document.getElementById('player-names').value.split(',').map(n => n.trim()).filter(n => n !== "");
    const isDuelo = pList.length === 2;
    document.getElementById('display-modo').innerText = isDuelo ? "Modo Duelo (X1)" : "Modo Torneio";
    const hist = isDuelo ? (cloudData.ranking_duelo || {}) : (cloudData.ranking_torneio || {});
    
    const r = (f) => [...pList].sort((a,b) => (hist[b]?.[f]||0) - (hist[a]?.[f]||0)).map((p, i) => `<div class="rank-item"><span>${i+1}¬∫ ${p}</span><b>${hist[p]?.[f]||0}</b></div>`).join('');
    document.getElementById('hist-titulos').innerHTML = r('titulos');
    document.getElementById('hist-pontos').innerHTML = r('pontos');
    document.getElementById('hist-gols').innerHTML = r('gols');

    const opts = pList.map(p => `<option value="${p}">${p}</option>`).join('');
    document.getElementById('p1-select').innerHTML = opts; document.getElementById('p2-select').innerHTML = opts;
    if(pList.length > 1 && document.getElementById('p2-select').selectedIndex === 0) document.getElementById('p2-select').selectedIndex = 1;

    let html = '';
    const jData = cloudData.jogos || {};
    const turnos = ["üïπÔ∏è Turno 1", "üïπÔ∏è Turno 2", "üïπÔ∏è Turno 3"];
    turnos.forEach((cat, cIdx) => {
        html += `<div class="match-section"><div style="text-align:center; font-size:0.65rem; color:var(--gold); margin-bottom:12px; font-weight:900; text-transform:uppercase;">${cat}</div>`;
        if (isDuelo) { for (let k = 1; k <= 2; k++) html += criarLinhaJogoCloud(cIdx, 0, 1, k, pList, jData); }
        else { for (let i = 0; i < pList.length; i++) { for (let j = i + 1; j < pList.length; j++) html += criarLinhaJogoCloud(cIdx, i, j, 0, pList, jData); } }
        html += `</div>`;
    });
    document.getElementById('lista-confrontos').innerHTML = html;
    calcularTabela(); renderRivalidade();
}

function criarLinhaJogoCloud(cIdx, i, j, k, pList, jData) {
    const id = `c${cIdx}_p${i}_p${j}_k${k}`;
    const jg = jData[id] || { g1: "", g2: "", t1: "", t2: "", tentativas: 0 };
    const travado = jg.tentativas >= 2;
    return `<div class="match-row">
        <div class="player-side left"><span class="p-name">${pList[i]}</span><div class="team-box"><button class="btn-dice" onclick="sortearTime('${id}t1')">üé≤</button><input class="t-input" id="${id}t1" value="${jg.t1||''}" onchange="salvarTime('${id}',1,this.value)"></div></div>
        <input type="number" class="score-input placar" id="${id}s1" value="${jg.g1}" ${travado?'disabled':''} oninput="calcularTabela()">
        <div style="text-align:center; color:var(--gold); font-weight:900; opacity:0.3; width:25px;">x</div>
        <input type="number" class="score-input placar" id="${id}s2" value="${jg.g2}" ${travado?'disabled':''} oninput="calcularTabela()">
        <div class="player-side right"><span class="p-name">${pList[j]}</span><div class="team-box"><input class="t-input" id="${id}t2" value="${jg.t2||''}" onchange="salvarTime('${id}',2,this.value)"><button class="btn-dice" onclick="sortearTime('${id}t2')">üé≤</button></div></div>
        <button class="btn-lock" onclick="confirmarJogo('${id}')">${travado?'üîí':'üîì'}</button>
    </div>`;
}

function salvarTime(id, p, v) { db.ref(`salas/${salaAtual}/jogos/${id}`).update({ ['t'+p]: v }); }

function sortearTime(inputId) {
    const ativos = document.querySelectorAll('.filter-chip.active input');
    let pool = [];
    ativos.forEach(a => pool = pool.concat(timesPool[a.value] || []));
    const sorteado = (pool.length > 0 ? pool : timesPool.top3)[Math.floor(Math.random() * (pool.length || 5))];
    document.getElementById(inputId).value = sorteado;
    document.getElementById(inputId).dispatchEvent(new Event('change'));
}

function confirmarJogo(id) {
    const g1 = document.getElementById(id+'s1').value;
    const g2 = document.getElementById(id+'s2').value;
    if(g1 === "" || g2 === "") return;
    db.ref(`salas/${salaAtual}/jogos/${id}`).once('value', (s) => {
        const d = s.val() || { tentativas: 0 };
        if(d.tentativas >= 2) return;
        if(confirm(`Confirmar? (Tentativa ${d.tentativas+1}/2)`)) {
            db.ref(`salas/${salaAtual}/jogos/${id}`).update({ g1: parseInt(g1), g2: parseInt(g2), tentativas: d.tentativas + 1 });
        }
    });
}

function calcularTabela() {
    const pList = document.getElementById('player-names').value.split(',').map(n => n.trim()).filter(n => n !== "");
    let t = {}; pList.forEach(p => t[p] = { p: 0, v: 0, e: 0, d: 0, sg: 0, gp: 0 });
    document.querySelectorAll('.match-row').forEach(row => {
        const pNames = row.querySelectorAll('.p-name');
        const scores = row.querySelectorAll('.placar');
        const g1 = scores[0].value !== "" ? parseInt(scores[0].value) : null;
        const g2 = scores[1].value !== "" ? parseInt(scores[1].value) : null;
        if(g1 !== null && g2 !== null) {
            const p1 = pNames[0].innerText; const p2 = pNames[1].innerText;
            if(!t[p1] || !t[p2]) return;
            t[p1].gp += g1; t[p2].gp += g2; t[p1].sg += (g1-g2); t[p2].sg += (g2-g1);
            if(g1 > g2) { t[p1].p += 3; t[p1].v += 1; t[p2].d += 1; }
            else if(g2 > g1) { t[p2].p += 3; t[p2].v += 1; t[p1].d += 1; }
            else { t[p1].p += 1; t[p2].p += 1; t[p1].e += 1; t[p2].e += 1; }
        }
    });
    const ord = Object.entries(t).sort((a,b) => b[1].p - a[1].p || b[1].sg - a[1].sg);
    document.getElementById('corpo-tabela').innerHTML = ord.map((p, i) => `<tr><td style="font-weight:900">${i+1}¬∫</td><td align="left" style="font-weight:800; text-align:left;">${p[0]}</td><td style="color:var(--gold); font-weight:900">${p[1].p}</td><td>${p[1].v}</td><td>${p[1].e}</td><td>${p[1].d}</td><td>${p[1].sg}</td></tr>`).join('');
    return t;
}

function renderRivalidade() {
    const p1 = document.getElementById('p1-select').value;
    const p2 = document.getElementById('p2-select').value;
    if(!p1 || !p2 || p1 === p2) return;
    const chave = [p1, p2].sort().join('_vs_');
    const riv = (cloudData.rivalidade || {})[chave] || { [p1]: 0, [p2]: 0, ultimo: "-" };
    document.getElementById('rival-p1-name').innerText = p1; document.getElementById('rival-p2-name').innerText = p2;
    document.getElementById('rival-v-1').innerText = riv[p1] || 0; document.getElementById('rival-v-2').innerText = riv[p2] || 0;
    document.getElementById('val-ultimo').innerText = riv.ultimo || "-";
    const total = (riv[p1]||0) + (riv[p2]||0);
    const perc = total === 0 ? 50 : (riv[p1]/total)*100;
    document.getElementById('bar-1').style.width = perc + "%"; document.getElementById('bar-2').style.width = (100 - perc) + "%";
}

function salvarPlayersNuvem() { if(confirm("Mudar jogadores e resetar rodada?")) db.ref(`salas/${salaAtual}`).update({ players: document.getElementById('player-names').value, jogos: null }); }
function limparPlacaresNuvem() { if(confirm("Limpar placares desta rodada na nuvem?")) db.ref(`salas/${salaAtual}/jogos`).remove(); }

function finalizarTurno() {
    const s = calcularTabela();
    const rows = document.getElementById('corpo-tabela').rows;
    if(rows.length === 0) return;
    const win = rows[0].cells[1].innerText;
    const pass = prompt("Senha Master:");
    if(pass !== MASTER_KEY) return;
    const pList = document.getElementById('player-names').value.split(',').map(n => n.trim()).filter(n => n !== "");
    const dbPath = pList.length === 2 ? 'ranking_duelo' : 'ranking_torneio';
    const hist = cloudData[dbPath] || {};
    pList.forEach(p => { if(!hist[p]) hist[p] = { titulos: 0, pontos: 0, gols: 0 }; hist[p].pontos += s[p].p; hist[p].gols += s[p].gp; });
    hist[win].titulos++;
    let riv = cloudData.rivalidade || {};
    Object.entries(cloudData.jogos || {}).forEach(([id, jg]) => {
        if(jg.g1 !== "" && jg.g2 !== "" && jg.g1 !== jg.g2) {
            const pts = id.split('_');
            const n1 = pList[pts[1].replace('p','')]; const n2 = pList[pts[2].replace('p','')];
            const vencedor = jg.g1 > jg.g2 ? n1 : n2;
            const chave = [n1, n2].sort().join('_vs_');
            if(!riv[chave]) riv[chave] = { [n1]: 0, [n2]: 0 };
            riv[chave][vencedor]++; riv[chave].ultimo = vencedor;
        }
    });
    confetti({ particleCount: 200, spread: 80, origin: { y: 0.6 } });
    db.ref(`salas/${salaAtual}`).update({ [dbPath]: hist, rivalidade: riv, jogos: null });
}
</script>
</body>
</html>
