<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EA FC Pro - Elite Edition</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="icon" type="image/png" href="icon.png">

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        :root {
            --bg: #0f172a; --card-bg: rgba(30, 41, 59, 0.7);
            --accent: #3b82f6; --gold: #f59e0b;
            --success: #10b981; --text: #f8fafc;
            --danger: #ef4444;
        }

        body {
            font-family: 'Inter', system-ui, sans-serif; background-color: var(--bg);
            color: var(--text); padding: 0; margin: 0; min-height: 100vh;
            overflow: hidden; /* Trava o scroll inicial */
        }

        /* TELA DE BOAS-VINDAS */
        #welcome-screen {
            position: fixed; inset: 0; z-index: 9999;
            display: flex; align-items: center; justify-content: center;
            background: url('telainicial.jpg') no-repeat center center;
            background-size: cover;
            transition: opacity 0.8s ease;
        }

        #welcome-screen::after {
            content: ""; position: absolute; inset: 0;
            background: rgba(15, 23, 42, 0.5);
            z-index: 1;
        }

        .welcome-card {
            position: relative; z-index: 2;
            width: 85%; max-width: 320px;
            background: rgba(255, 255, 255, 0.1); 
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(15px); 
            -webkit-backdrop-filter: blur(15px);
            border-radius: 28px; padding: 30px; text-align: center;
            box-shadow: 0 25px 50px rgba(0,0,0,0.5);
        }

        .welcome-btn {
            width: 100%; padding: 15px; border-radius: 12px; border: none;
            font-weight: 900; text-transform: uppercase; cursor: pointer; margin-bottom: 12px; transition: 0.3s;
        }

        /* APP PRINCIPAL - TRAVA ANTI-DUPLICA√á√ÉO */
        .main-app { 
            padding: 10px; 
            display: none !important; /* For√ßa esconder no carregamento */
            opacity: 0; 
            transition: opacity 0.5s; 
            overflow-y: auto; 
            height: 100vh; 
        }

        .container { max-width: 800px; margin: auto; padding-bottom: 50px; }
        .header-section { text-align: center; margin-bottom: 20px; padding-top: 10px; }
        .mode-title { text-transform: uppercase; font-weight: 900; font-size: 1.1rem; color: var(--gold); margin: 0; letter-spacing: 1px; }
        .participants-row { display: flex; flex-direction: column; align-items: center; gap: 8px; margin-top: 15px; }
        .section-title { display: flex; align-items: center; gap: 10px; margin: 30px 0 15px; text-transform: uppercase; font-size: 0.7rem; font-weight: 900; color: var(--gold); letter-spacing: 1.5px; }
        .section-title::after { content: ""; flex: 1; height: 1px; background: linear-gradient(to right, rgba(245, 158, 11, 0.5), transparent); }
        .filter-section { background: var(--card-bg); border-radius: 12px; padding: 8px; display: flex; gap: 6px; border: 1px solid rgba(255,255,255,0.1); overflow-x: auto; scrollbar-width: none; margin-top:10px; }
        .btn-tds { background: var(--gold); color: black; border: none; padding: 5px 12px; border-radius: 20px; font-size: 0.6rem; font-weight: 900; cursor: pointer; flex-shrink: 0; }
        .filter-chip { font-size: 0.6rem; background: rgba(15, 23, 42, 0.8); padding: 5px 10px; border-radius: 20px; border: 1px solid #475569; cursor: pointer; color: #94a3b8; font-weight: bold; white-space: nowrap; }
        .filter-chip.active { border-color: var(--gold); color: white; background: rgba(245, 158, 11, 0.4); }
        .filter-chip input { display: none; }
        .rankings-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .rank-card { background: var(--card-bg); border-radius: 10px; padding: 8px; border: 1px solid rgba(255,255,255,0.1); }
        .rank-card h3 { margin: 0 0 8px 0; font-size: 0.5rem; color: var(--gold); text-align: center; text-transform: uppercase; }
        .rank-item { display: flex; justify-content: space-between; padding: 4px 0; font-size: 0.75rem; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .table-container { background: var(--card-bg); border-radius: 12px; padding: 10px; border: 1px solid rgba(255,255,255,0.1); }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        td { padding: 8px 4px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .td-name { text-align: left !important; font-weight: 800; padding-left: 10px; }
        .match-section { background: var(--card-bg); border-radius: 12px; padding: 12px; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.05); }
        .match-row { display: grid; grid-template-columns: 1fr 45px 25px 45px 1fr 35px; align-items: center; padding: 15px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .player-side.left { text-align: right; padding-right: 15px; }
        .player-side.right { text-align: left; padding-left: 15px; }
        .t-input { background: rgba(15, 23, 42, 0.9); border: 1px solid rgba(255,255,255,0.1); color: #fff; padding: 5px 0; border-radius: 4px; font-size: 0.68rem; width: 100%; text-align: center; outline: none; }
        .score-input { background: var(--accent); border: none; border-radius: 6px; color: white; height: 42px; font-size: 1.4rem; font-weight: 900; text-align: center; width: 45px; }
        .score-input:disabled { background: #334155; opacity: 0.6; }
        .rivalry-section { background: linear-gradient(180deg, rgba(30, 41, 59, 0.9) 0%, rgba(15, 23, 42, 1) 100%); border-radius: 16px; padding: 20px; border: 1px solid rgba(245, 158, 11, 0.3); }
        .dominance-bar-container { height: 8px; background: rgba(255,255,255,0.1); border-radius: 10px; margin: 20px 0; overflow: hidden; display: flex; }
        .dom-fill { height: 100%; transition: width 0.6s ease; }
        .btn-finish { background: var(--success); color: white; width: 100%; padding: 16px; border-radius: 12px; border: none; font-weight: 900; text-transform: uppercase; cursor: pointer; margin-top: 10px; }
        .btn-clear { background: rgba(239, 68, 68, 0.1); color: var(--danger); border: 1px solid var(--danger); width: 100%; padding: 10px; border-radius: 10px; font-size: 0.75rem; font-weight: bold; cursor: pointer; margin-bottom: 10px; }
        .admin-section { background: rgba(239, 68, 68, 0.1); border: 1px dashed var(--danger); border-radius: 12px; padding: 15px; margin: 20px 0; display: none; }
        .admin-edit-row { display: grid; grid-template-columns: 1fr 50px 50px 50px; gap: 5px; margin-bottom: 8px; align-items: center; }
        .admin-input { background: #000; border: 1px solid #444; color: var(--gold); text-align: center; padding: 5px; font-size: 0.7rem; border-radius: 4px; width: 100%; }
        .last-room-box { margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); }
    </style>
</head>
<body>

<datalist id="lista-times"></datalist>

<div id="welcome-screen">
    <div class="welcome-card">
        <h2 style="font-weight:900; color:white; text-transform:uppercase; margin:0; letter-spacing: 2px;">EA FC Pro</h2>
        <p style="color:#cbd5e1; font-size:0.8rem; margin:10px 0 25px;">Onde os mitos se encontram.</p>
        
        <button class="welcome-btn" style="background:var(--gold); color:black;" onclick="novaSala()">CRIAR NOVA SALA</button>
        <button class="welcome-btn" style="background:rgba(255, 255, 255, 0.1); color:white; border:1px solid rgba(255,255,255,0.2);" onclick="trocarSala()">ENTRAR EM SALA</button>
        
        <div id="last-room-container" class="last-room-box" style="display:none;">
            <p style="font-size:0.7rem; color:#94a3b8; margin-bottom:10px;">Continuar de onde parou?</p>
            <button id="btn-resume" class="welcome-btn" style="background:var(--accent); color:white; margin-bottom:0;"></button>
        </div>
    </div>
</div>

<div id="main-app" class="main-app">
    <div class="container">
        <div class="header-section">
            <p id="label-sala-topo" style="font-size:0.65rem; color:var(--gold); margin:0; text-transform:uppercase; letter-spacing:2px; font-weight: bold; cursor:pointer;">SALA: ...</p>
            <h1 id="mode-title-display" class="mode-title">Torneio Champions</h1>
            
            <div class="participants-row">
                <input type="text" id="player-names" onchange="salvarPlayersNuvem()" placeholder="Ex: Jo√£o, Deymmes" style="background:transparent; border:none; border-bottom:1px solid var(--accent); color:white; font-size:1.1rem; font-weight:bold; width:80%; text-align:center; outline:none;">
                <button onclick="sairDaSala()" style="background:none; border:none; color:var(--danger); font-size:0.65rem; font-weight:bold; cursor:pointer; text-transform:uppercase; margin-top:5px;">[ Sair e Voltar ao In√≠cio ]</button>
            </div>

            <div id="filter-ui" class="filter-section">
                <button class="btn-tds" onclick="toggleTodosFiltros()">TDS</button>
                <label class="filter-chip active"><input type="checkbox" value="top3" checked onchange="toggleFiltro(this)">‚≠ê TOP 3</label>
                <label class="filter-chip"><input type="checkbox" value="ing" onchange="toggleFiltro(this)">ING</label>
                <label class="filter-chip"><input type="checkbox" value="esp" onchange="toggleFiltro(this)">ESP</label>
                <label class="filter-chip"><input type="checkbox" value="ita" onchange="toggleFiltro(this)">ITA</label>
                <label class="filter-chip"><input type="checkbox" value="ale" onchange="toggleFiltro(this)">ALE</label>
                <label class="filter-chip"><input type="checkbox" value="sel" onchange="toggleFiltro(this)">SEL</label>
            </div>
        </div>

        <div class="section-title">üèÜ Quadro de Honra</div>
        <div class="rankings-row">
            <div class="rank-card"><h3>üèÜ T√≠tulos</h3><div id="hist-titulos"></div></div>
            <div class="rank-card"><h3>üìà Pontos</h3><div id="hist-pontos"></div></div>
            <div class="rank-card"><h3>‚öΩ Gols</h3><div id="hist-gols"></div></div>
        </div>

        <div class="section-title">üìä Classifica√ß√£o</div>
        <div class="table-container">
            <table>
                <thead><tr><th>Pos</th><th style="text-align:left">Player</th><th>P</th><th>V</th><th>SG</th></tr></thead>
                <tbody id="corpo-tabela"></tbody>
            </table>
        </div>

        <div class="section-title">üïπÔ∏è Confrontos</div>
        <div id="lista-confrontos"></div>

        <div class="section-title">‚öîÔ∏è Rivalidade</div>
        <div class="rivalry-section">
            <div style="display:flex; gap:10px; justify-content:center; margin-bottom:20px;">
                <select id="p1-select" class="t-input" onchange="renderRivalidade()" style="width:45%; height:35px;"></select>
                <span style="color:var(--gold); font-weight:bold; align-self:center;">VS</span>
                <select id="p2-select" class="t-input" onchange="renderRivalidade()" style="width:45%; height:35px;"></select>
            </div>
            <div style="display:grid; grid-template-columns:1fr 100px 1fr; align-items:center; gap:10px;">
                <div id="rival-name-1" style="text-align:right; font-weight:900;">-</div>
                <div style="font-size:2.2rem; font-weight:900; color:var(--gold); text-align:center;"><span id="rival-v-1">0</span>:<span id="rival-v-2">0</span></div>
                <div id="rival-name-2" style="text-align:left; font-weight:900;">-</div>
            </div>
            <div class="dominance-bar-container">
                <div id="bar-1" class="dom-fill" style="background:var(--accent); width:50%;"></div>
                <div id="bar-2" class="dom-fill" style="background:var(--gold); width:50%;"></div>
            </div>
        </div>

        <button class="btn-clear" onclick="limparPlacares()">üßπ Limpar placares</button>
        <button class="btn-finish" onclick="finalizarTurno()">Encerrar e Sincronizar Tudo</button>

        <div style="text-align: center;"><button onclick="toggleAdmin()" style="background:none; border:none; color:var(--danger); font-size:0.6rem; margin-top:20px; cursor:pointer;">‚öôÔ∏è ACESSO RESTRITO</button></div>
        <div id="admin-panel" class="admin-section">
            <div id="admin-edit-container"></div>
            <button class="welcome-btn" style="background:var(--success); color:white; margin-top:15px; font-size:0.7rem;" onclick="salvarAjusteRanking()">SALVAR ALTERA√á√ïES DE RANKING</button>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:15px;">
                <button class="btn-admin" style="background:var(--accent); color:white;" onclick="fazerBackup()">üì• Backup JSON</button>
                <button class="btn-admin" style="background:var(--danger); color:white;" onclick="resetTotal()">‚ö†Ô∏è Reset Total</button>
            </div>
        </div>
    </div>
</div>

<script>
const MASTER_KEY = "1234"; 
const firebaseConfig = {
    apiKey: "AIzaSyDZ1MD_w9Zt6Hyl0jZlvNv3gSP5j0UVY6E",
    authDomain: "ea-fc-pro.firebaseapp.com",
    databaseURL: "https://ea-fc-pro-default-rtdb.firebaseio.com",
    projectId: "ea-fc-pro",
    storageBucket: "ea-fc-pro.firebasestorage.app",
    messagingSenderId: "1017852236404",
    appId: "1:1017852236404:web:dd32d9e180b1a101d47721"
};

const timesPool = {
    ing: ["Man. City", "Liverpool", "Chelsea", "Arsenal", "Tottenham", "Man. United", "Newcastle", "Aston Villa", "West Ham", "Brighton"],
    esp: ["Real Madrid", "Barcelona", "Atl√©tico Madrid", "Girona", "Sevilla", "Real Sociedad", "Betis", "Villarreal"],
    ita: ["Inter Mil√£o", "Juventus", "AC Milan", "Napoli", "Atalanta", "AS Roma", "Lazio", "Fiorentina"],
    ale: ["Bayer Leverkusen", "Bayern M√ºnchen", "Borussia Dortmund", "RB Leipzig", "Stuttgart", "Eintracht Frankfurt"],
    sel: ["Brasil üáßüá∑", "Espanha üá™üá∏", "Fran√ßa üá´üá∑", "Argentina üá¶üá∑", "Portugal üáµüáπ", "Inglaterra üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø", "Alemanha üá©üá™", "Holanda üá≥üá±", "B√©lgica üáßüá™"],
    top3: ["Real Madrid", "Man. City", "Bayern M√ºnchen", "PSG", "Inter Mil√£o", "Liverpool", "Bayer Leverkusen", "Arsenal"]
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
let salaAtual = "";
let cloudData = {};

window.onload = () => {
    const session = sessionStorage.getItem('FC_SESSION_ROOM');
    if(session) {
        entrarApp(session); 
    } else {
        const history = localStorage.getItem('FC_LAST_ROOM');
        if(history) {
            document.getElementById('last-room-container').style.display = 'block';
            document.getElementById('btn-resume').innerText = history.toUpperCase();
            document.getElementById('btn-resume').onclick = () => entrarApp(history);
        }
    }
};

function entrarApp(nome) {
    salaAtual = nome.replace(/\s+/g, '');
    sessionStorage.setItem('FC_SESSION_ROOM', salaAtual);
    localStorage.setItem('FC_LAST_ROOM', salaAtual);
    
    const welcome = document.getElementById('welcome-screen');
    const app = document.getElementById('main-app');

    // 1. Inicia transi√ß√£o de sa√≠da da tela de boas-vindas
    welcome.style.opacity = '0';
    
    setTimeout(() => {
        welcome.style.display = 'none';
        
        // 2. FOR√áA O APP A APARECER QUEBRANDO O !IMPORTANT DO CSS
        app.style.setProperty('display', 'block', 'important');
        
        setTimeout(() => {
            app.style.opacity = '1';
            document.body.style.overflow = 'auto'; // Reativa scroll
        }, 50);
    }, 800);
    
    document.getElementById('label-sala-topo').innerText = "SALA: " + salaAtual;
    
    db.ref('salas/' + salaAtual).on('value', snap => {
        cloudData = snap.val() || {};
        if(cloudData.players) document.getElementById('player-names').value = cloudData.players;
        atualizarInterface();
        renderAdminEdit();
    });
}

function novaSala() { const n = prompt("Nome da nova Resenha:"); if(n) entrarApp(n); }
function trocarSala() { const n = prompt("Nome da sala:"); if(n) entrarApp(n); }
function sairDaSala() { if(confirm("Voltar para o in√≠cio?")) { sessionStorage.removeItem('FC_SESSION_ROOM'); location.reload(); } }

function toggleTodosFiltros() {
    const checkboxes = document.querySelectorAll('#filter-ui input[type="checkbox"]');
    const status = Array.from(checkboxes).some(cb => !cb.checked);
    checkboxes.forEach(cb => { cb.checked = status; cb.parentElement.classList.toggle('active', status); });
    updateDatalist();
}

function toggleFiltro(el) { el.parentElement.classList.toggle('active', el.checked); updateDatalist(); }
function updateDatalist() {
    const ativos = document.querySelectorAll('.filter-chip.active input');
    let h = ''; ativos.forEach(a => timesPool[a.value].forEach(t => h += `<option value="${t}">`));
    document.getElementById('lista-times').innerHTML = h;
}

function atualizarInterface() {
    const pNames = document.getElementById('player-names').value.split(',').map(x => x.trim()).filter(x => x !== "");
    const isDuelo = pNames.length === 2;
    document.getElementById('mode-title-display').innerText = isDuelo ? "Duelo Elite X1" : "Torneio Champions";
    
    const dbPath = isDuelo ? 'ranking_duelo' : 'ranking_torneio';
    const hist = cloudData[dbPath] || {};

    const rank = (f) => [...pNames].sort((a,b) => (hist[b]?.[f]||0) - (hist[a]?.[f]||0)).map((p,i) => `
        <div class="rank-item"><span>${i+1}¬∫ ${p}</span><b>${hist[p]?.[f]||0}</b></div>`).join('');
    document.getElementById('hist-titulos').innerHTML = rank('titulos');
    document.getElementById('hist-pontos').innerHTML = rank('pontos');
    document.getElementById('hist-gols').innerHTML = rank('gols');

    document.getElementById('p1-select').innerHTML = pNames.map(p => `<option value="${p}">${p}</option>`).join('');
    document.getElementById('p2-select').innerHTML = pNames.map(p => `<option value="${p}">${p}</option>`).join('');

    let html = '';
    const turnos = ["üïπÔ∏è Turno 1", "üïπÔ∏è Turno 2", "üïπÔ∏è Turno 3"];
    const jData = cloudData.jogos || {};
    
    turnos.forEach((cat, cIdx) => {
        html += `<div class="match-section"><div style="text-align:center; font-size:0.6rem; color:var(--gold); margin-bottom:10px; font-weight:900;">${cat}</div>`;
        if(isDuelo) { for(let k=1; k<=2; k++) html += gerarLinha(cIdx, 0, 1, k, pNames, jData); }
        else { for(let i=0; i<pNames.length; i++) { for(let j=i+1; j<pNames.length; j++) html += gerarLinha(cIdx, i, j, 0, pNames, jData); } }
        html += `</div>`;
    });
    document.getElementById('lista-confrontos').innerHTML = html;
    updateDatalist(); calcularTabela(); renderRivalidade();
}

function gerarLinha(c, i, j, k, pNames, jData) {
    const id = `c${c}_p${i}_p${j}_k${k}`;
    const jg = jData[id] || { g1: "", g2: "", t1: "", t2: "", tentativas: 0 };
    const trav = jg.tentativas >= 2;
    return `
    <div class="match-row">
        <div class="player-side left"><span class="p-name">${pNames[i]}</span><div class="team-box"><input class="t-input" id="${id}t1" list="lista-times" value="${jg.t1||''}" onchange="salvarTime('${id}',1,this.value)"></div></div>
        <input type="number" class="score-input placar" id="${id}s1" value="${jg.g1}" ${trav?'disabled':''} oninput="salvarPlacarFirebase('${id}', 1, this.value)">
        <div style="text-align:center; color:var(--gold); font-weight:900; opacity:0.3;">x</div>
        <input type="number" class="score-input placar" id="${id}s2" value="${jg.g2}" ${trav?'disabled':''} oninput="salvarPlacarFirebase('${id}', 2, this.value)">
        <div class="player-side right"><span class="p-name">${pNames[j]}</span><div class="team-box"><input class="t-input" id="${id}t2" list="lista-times" value="${jg.t2||''}" onchange="salvarTime('${id}',2,this.value)"></div></div>
        <button style="background:none; border:none; font-size:1.1rem; cursor:pointer;" onclick="gerirAcao('${id}')">${trav ? 'üîí' : (jg.g1 !== "" || jg.g2 !== "" ? 'üîì' : 'üé≤')}</button>
    </div>`;
}

function salvarPlacarFirebase(id, player, valor) {
    db.ref(`salas/${salaAtual}/jogos/${id}`).update({ ["g" + player]: valor });
    calcularTabela();
}

function gerirAcao(id) {
    const g1 = document.getElementById(id+'s1').value;
    const g2 = document.getElementById(id+'s2').value;
    if(g1 === "" && g2 === "") { sortearTime(id); } 
    else {
        const jg = (cloudData.jogos || {})[id] || { tentativas: 0 };
        if(jg.tentativas < 2 && confirm("Confirmar resultado definitivo?")) {
            db.ref(`salas/${salaAtual}/jogos/${id}`).update({ g1: parseInt(g1), g2: parseInt(g2), tentativas: jg.tentativas + 1 });
        }
    }
}

function sortearTime(idJogo) {
    const ativos = document.querySelectorAll('.filter-chip.active input');
    let pool = []; ativos.forEach(a => pool = pool.concat(timesPool[a.value]));
    const ocupados = [];
    if (cloudData.jogos) {
        Object.values(cloudData.jogos).forEach(jg => { if (jg.t1) ocupados.push(jg.t1); if (jg.t2) ocupados.push(jg.t2); });
    }
    let disp = pool.filter(t => !ocupados.includes(t));
    if(disp.length < 2) disp = pool; 
    const t1 = disp[Math.floor(Math.random() * disp.length)];
    let t2 = disp[Math.floor(Math.random() * disp.length)];
    while(t1 === t2 && disp.length > 1) t2 = disp[Math.floor(Math.random() * disp.length)];
    db.ref(`salas/${salaAtual}/jogos/${idJogo}`).update({ t1: t1, t2: t2 });
}

function salvarTime(id, p, v) { db.ref(`salas/${salaAtual}/jogos/${id}`).update({ ['t'+p]: v }); }
function salvarPlayersNuvem() { if(confirm("Mudar jogadores resetar√° a rodada. Prosseguir?")) db.ref(`salas/${salaAtual}`).update({ players: document.getElementById('player-names').value, jogos: null }); }
function limparPlacares() { if(confirm("Limpar placares?")) db.ref(`salas/${salaAtual}/jogos`).remove(); }

function calcularTabela() {
    const pNames = document.getElementById('player-names').value.split(',').map(x => x.trim()).filter(x => x !== "");
    let t = {}; pNames.forEach(p => t[p] = { p: 0, v: 0, sg: 0 });
    document.querySelectorAll('.match-row').forEach(row => {
        const names = row.querySelectorAll('.p-name');
        const scores = row.querySelectorAll('.placar');
        const g1 = scores[0].value !== "" ? parseInt(scores[0].value) : null;
        const g2 = scores[1].value !== "" ? parseInt(scores[1].value) : null;
        if(g1 !== null && g2 !== null) {
            const n1 = names[0].innerText; const n2 = names[1].innerText;
            if(!t[n1] || !t[n2]) return;
            t[n1].sg += (g1-g2); t[n2].sg += (g2-g1);
            if(g1 > g2) { t[n1].p += 3; t[n1].v++; } 
            else if(g2 > g1) { t[n2].p += 3; t[n2].v++; } 
            else { t[n1].p += 1; t[n2].p += 1; }
        }
    });
    const ord = Object.entries(t).sort((a,b) => b[1].p - a[1].p || b[1].sg - a[1].sg);
    document.getElementById('corpo-tabela').innerHTML = ord.map((p,i) => `
        <tr><td>${i+1}¬∫</td><td class="td-name">${p[0]}</td><td>${p[1].p}</td><td>${p[1].v}</td><td>${p[1].sg}</td></tr>`).join('');
}

function renderRivalidade() {
    const p1 = document.getElementById('p1-select').value;
    const p2 = document.getElementById('p2-select').value;
    if(!p1 || !p2 || p1 === p2) return;
    const chave = [p1, p2].sort().join('_vs_');
    const riv = (cloudData.rivalidade || {})[chave] || { [p1]: 0, [p2]: 0 };
    document.getElementById('rival-name-1').innerText = p1; document.getElementById('rival-name-2').innerText = p2;
    document.getElementById('rival-v-1').innerText = riv[p1] || 0; document.getElementById('rival-v-2').innerText = riv[p2] || 0;
    const tot = (riv[p1]||0) + (riv[p2]||0);
    const perc = tot === 0 ? 50 : (riv[p1]/tot)*100;
    document.getElementById('bar-1').style.width = perc + "%"; document.getElementById('bar-2').style.width = (100 - perc) + "%";
}

function finalizarTurno() {
    const pass = prompt("Senha Master:"); if(pass !== MASTER_KEY) return;
    const pNames = document.getElementById('player-names').value.split(',').map(x => x.trim()).filter(x => x !== "");
    const dbPath = pNames.length === 2 ? 'ranking_duelo' : 'ranking_torneio';
    const hist = cloudData[dbPath] || {};
    const win = document.getElementById('corpo-tabela').rows[0]?.cells[1].innerText;
    pNames.forEach(p => { if(!hist[p]) hist[p] = { titulos:0, pontos:0, gols:0 }; });
    if(win) hist[win].titulos++;
    let riv = cloudData.rivalidade || {};
    Object.entries(cloudData.jogos || {}).forEach(([id, jg]) => {
        if(jg.g1 !== "" && jg.g2 !== "" && jg.g1 !== jg.g2) {
            const parts = id.split('_');
            const n1 = pNames[parts[1].replace('p','')]; const n2 = pNames[parts[2].replace('p','')];
            const vencedor = jg.g1 > jg.g2 ? n1 : n2;
            const chave = [n1, n2].sort().join('_vs_');
            if(!riv[chave]) riv[chave] = { [n1]:0, [n2]:0 };
            riv[chave][vencedor]++;
        }
    });
    confetti({ particleCount: 200, spread: 80, origin: { y: 0.6 } });
    db.ref(`salas/${salaAtual}`).update({ [dbPath]: hist, rivalidade: riv, jogos: null });
}

function renderAdminEdit() {
    const pNames = document.getElementById('player-names').value.split(',').map(x => x.trim()).filter(x => x !== "");
    const isDuelo = pNames.length === 2;
    const dbPath = isDuelo ? 'ranking_duelo' : 'ranking_torneio';
    const hist = cloudData[dbPath] || {};
    let html = '<div class="admin-edit-row" style="font-weight:bold; color:var(--gold);"><span>Player</span><span>üèÜ</span><span>üìà</span><span>‚öΩ</span></div>';
    pNames.forEach(p => {
        const d = hist[p] || { titulos: 0, pontos: 0, gols: 0 };
        html += `<div class="admin-edit-row">
            <span style="font-size:0.6rem; overflow:hidden;">${p}</span>
            <input type="number" class="admin-input" id="edit-t-${p}" value="${d.titulos}">
            <input type="number" class="admin-input" id="edit-p-${p}" value="${d.pontos}">
            <input type="number" class="admin-input" id="edit-g-${p}" value="${d.gols}">
        </div>`;
    });
    document.getElementById('admin-edit-container').innerHTML = html;
}

function salvarAjusteRanking() {
    const pNames = document.getElementById('player-names').value.split(',').map(x => x.trim()).filter(x => x !== "");
    const isDuelo = pNames.length === 2;
    const dbPath = isDuelo ? 'ranking_duelo' : 'ranking_torneio';
    let novoRanking = {};
    pNames.forEach(p => {
        novoRanking[p] = {
            titulos: parseInt(document.getElementById(`edit-t-${p}`).value) || 0,
            pontos: parseInt(document.getElementById(`edit-p-${p}`).value) || 0,
            gols: parseInt(document.getElementById(`edit-g-${p}`).value) || 0
        };
    });
    db.ref(`salas/${salaAtual}/${dbPath}`).set(novoRanking).then(() => alert("Ranking atualizado!"));
}

function toggleAdmin() { if(prompt("Senha:") === MASTER_KEY) { const s = document.getElementById('admin-panel'); s.style.display = s.style.display === 'block' ? 'none' : 'block'; } }
function fazerBackup() { const blob = new Blob([JSON.stringify(cloudData, null, 2)], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `backup_${salaAtual}.json`; a.click(); }
function resetTotal() { if(confirm("‚ö†Ô∏è APAGAR TUDO?")) { db.ref(`salas/${salaAtual}`).remove(); location.reload(); } }

if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
            .then(reg => console.log('SW registrado!', reg))
            .catch(err => console.log('Erro no SW:', err));
    });
}
</script>
</body>
</html>

